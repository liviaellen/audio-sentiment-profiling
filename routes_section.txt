@app.post("/audio")
async def handle_audio_stream(
    request: Request,
    sample_rate: int = Query(..., description="Audio sample rate in Hz"),
    uid: str = Query(..., description="User ID"),
    analyze_emotion: bool = Query(True, description="Whether to analyze emotions with Hume AI"),
    send_notification: Optional[bool] = Query(None, description="Override notification setting (uses config default if not specified)"),
    emotion_filters: Optional[str] = Query(None, description="Override emotion filters (uses config default if not specified)")
):
    """
    Endpoint to receive audio bytes from Omi device and analyze with Hume AI.

    Query Parameters:
        - sample_rate: Audio sample rate (e.g., 8000 or 16000)
        - uid: User unique ID
        - analyze_emotion: Whether to analyze emotions with Hume AI (default: True)
        - send_notification: Whether to send Omi notification (uses config default if not specified)
        - emotion_filters: JSON string of emotion:threshold pairs
                          Examples:
                          - '{"Anger":0.7}' - notify only if Anger >= 0.7
                          - '{"Anger":0.7,"Sadness":0.6}' - notify if Anger >= 0.7 OR Sadness >= 0.6
                          - null - notify for all detected emotions

    Body:
        - Binary audio data (application/octet-stream)

    Examples:
        # Basic emotion analysis
        POST /audio?sample_rate=16000&uid=user123

        # With notification for any emotion
        POST /audio?sample_rate=16000&uid=user123&send_notification=true

        # With notification only for high anger or sadness
        POST /audio?sample_rate=16000&uid=user123&send_notification=true&emotion_filters={"Anger":0.7,"Sadness":0.6}
    """
    try:
        # Update stats
        audio_stats["total_requests"] += 1
        audio_stats["last_request_time"] = datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC")
        audio_stats["last_uid"] = uid

        # Read audio bytes from request body
        audio_data = await request.body()

        if not audio_data:
            raise HTTPException(status_code=400, detail="No audio data received")

        # Generate filename with timestamp
        timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S_%f")
        filename = f"{uid}_{timestamp}.wav"

        # Create WAV header
        wav_header = create_wav_header(sample_rate, len(audio_data))

        # Combine header and audio data
        wav_data = wav_header + audio_data

        # Save to local audio_files directory
        audio_dir = Path("audio_files")
        audio_dir.mkdir(exist_ok=True)
        local_file_path = audio_dir / filename

        with open(local_file_path, 'wb') as f:
            f.write(wav_data)

        try:
            # Analyze with Hume AI if requested
            hume_results = None
            if analyze_emotion:
                print(f"Analyzing audio with Hume AI for user {uid}")
                hume_results = await analyze_audio_with_hume(str(local_file_path))
                print(f"Hume analysis complete: {hume_results.get('total_predictions', 0)} predictions")

                # Update stats
                if hume_results.get('success'):
                    audio_stats["successful_analyses"] += 1
                    # Extract top emotions from prosody predictions
                    recent_emotions = []
                    if hume_results.get('predictions'):
                        for pred in hume_results['predictions']:
                            if pred.get('top_3_emotions'):
                                recent_emotions = [
                                    f"{e['name']} ({e['score']:.2f})"
                                    for e in pred['top_3_emotions']
                                ]
                                # Track emotion counts for statistics
                                for emotion in pred['top_3_emotions']:
                                    emotion_name = emotion['name']
                                    if emotion_name not in audio_stats["emotion_counts"]:
                                        audio_stats["emotion_counts"][emotion_name] = 0
                                    audio_stats["emotion_counts"][emotion_name] += 1

                                # Update rizz score based on detected emotions
                                update_rizz_score(pred['top_3_emotions'])
                                print(f"üìä Rizz Score updated: {audio_stats['rizz_score']:.1f}")

                                break
                    if recent_emotions:
                        audio_stats["recent_emotions"] = recent_emotions

                    # Check emotion triggers and send notification
                    # Use config default if send_notification not explicitly provided
                    should_notify = send_notification if send_notification is not None else EMOTION_CONFIG.get('notification_enabled', False)
                    print(f"üîî Notification check: should_notify={should_notify}, has_predictions={bool(hume_results.get('predictions'))}")

                    if should_notify and hume_results.get('predictions'):
                        # Use emotion filters from parameter, or fall back to config
                        filters_dict = None
                        if emotion_filters:
                            try:
                                filters_dict = json.loads(emotion_filters)
                                print(f"Using custom emotion filters: {filters_dict}")
                            except json.JSONDecodeError as e:
                                print(f"Warning: Invalid emotion_filters JSON: {e}")
                                filters_dict = EMOTION_CONFIG.get('emotion_thresholds')
                        else:
                            # Use config defaults
                            filters_dict = EMOTION_CONFIG.get('emotion_thresholds')
                            print(f"Using config emotion filters: {filters_dict}")

                        # Check triggers
                        trigger_result = check_emotion_triggers(
                            hume_results['predictions'],
                            filters_dict
                        )
                        print(f"üìä Trigger check result: triggered={trigger_result['triggered']}, count={trigger_result['total_triggers']}")

                        if trigger_result['triggered']:
                            print(f"üîî Emotion trigger detected! {trigger_result['total_triggers']} emotions matched")

                            # Format notification message: Rizz first + emotions + motivational if needed
                            emotion_names = [e['name'] for e in trigger_result['emotions'][:3]]
                            notification_msg = get_rizz_notification_message(
                                audio_stats['rizz_score'],
                                emotion_names
                            )

                            # Send notification
                            notification_result = await send_omi_notification(uid, notification_msg)

                            # Add to response
                            hume_results['notification_sent'] = notification_result.get('success', False)
                            hume_results['triggered_emotions'] = trigger_result['emotions']

                            if notification_result.get('success'):
                                print(f"‚úì Notification sent successfully")
                            else:
                                print(f"‚úó Notification failed: {notification_result.get('error')}")
                        else:
                            print(f"‚ÑπÔ∏è  No emotion triggers matched (filters: {filters_dict})")
                            hume_results['notification_sent'] = False
                            hume_results['trigger_check'] = "No emotions matched threshold"

                else:
                    audio_stats["failed_analyses"] += 1


            response_data = {
                "message": "Audio processed successfully",
                "filename": filename,
                "uid": uid,
                "sample_rate": sample_rate,
                "data_size_bytes": len(audio_data),
                "timestamp": timestamp,
                "local_file_path": str(local_file_path.absolute())
            }

            # Add Hume results if available
            if hume_results:
                response_data["hume_analysis"] = hume_results

            return JSONResponse(
                status_code=200,
                content=response_data
            )
        except Exception as e:
            # If there's an error, clean up the file
            if local_file_path.exists():
                local_file_path.unlink()
            raise

    except HTTPException:
        raise
    except Exception as e:
        print(f"Error processing audio: {e}")
        raise HTTPException(status_code=500, detail=f"Internal server error: {str(e)}")


@app.get("/", response_class=HTMLResponse)
async def root():
    """Root endpoint with web interface"""
    hume_configured = bool(os.getenv('HUME_API_KEY'))
    omi_configured = bool(os.getenv('OMI_APP_ID') and os.getenv('OMI_API_KEY'))

    # Build emotion statistics HTML
    emotion_stats_html = ''
    if audio_stats['emotion_counts']:
        total_emotion_count = sum(audio_stats['emotion_counts'].values())
        max_emotion_count = max(audio_stats['emotion_counts'].values())
        sorted_emotions = sorted(audio_stats['emotion_counts'].items(), key=lambda x: x[1], reverse=True)[:12]

        emotion_items = []
        for emotion, count in sorted_emotions:
            percentage = (count / total_emotion_count * 100)
            bar_width = (count / max_emotion_count * 100)
            emotion_items.append(f'''
                <div class="emotion-stat-item">
                    <div class="emotion-stat-name">{emotion}</div>
                    <div class="emotion-stat-count">Count: {count} | {percentage:.1f}%</div>
                    <div class="emotion-stat-bar">
                        <div class="emotion-stat-fill" style="width: {bar_width:.1f}%"></div>
                    </div>
                </div>
            ''')

        emotion_stats_html = f'''
            <div style="margin: 20px 0;">
                <h3>üé≠ Emotion Statistics</h3>
                <p style="color: #666; font-size: 14px;">Cumulative counts and percentages of all detected emotions</p>
                <div class="emotion-stats">
                    {''.join(emotion_items)}
                </div>
            </div>
        '''

    # Build notifications HTML
    notifications_html = ''
    if audio_stats['recent_notifications']:
        notification_items = []
        for notif in audio_stats['recent_notifications'][:5]:
            masked_uid = notif['uid'][:4] + '****' if len(notif['uid']) > 4 else notif['uid']
            notification_items.append(f'''
                <div style="background: rgba(255,255,255,0.2); padding: 10px; margin-bottom: 10px; border-radius: 5px; border-left: 3px solid rgba(255,255,255,0.5);">
                    <p style="color: white; font-size: 13px; margin: 0 0 5px 0; font-weight: bold;">
                        {notif['message']}
                    </p>
                    <p style="color: rgba(255,255,255,0.7); font-size: 11px; margin: 0;">
                        <span style="margin-right: 10px;">üïí {notif['timestamp']}</span>
                        <span>üë§ {masked_uid}</span>
                    </p>
                </div>
            ''')

        notifications_html = f'''
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <h3 style="color: white; margin: 0 0 15px 0;">üì± Recent Notifications</h3>
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; max-height: 300px; overflow-y: auto;">
                    {''.join(notification_items)}
                </div>
            </div>
        '''
    else:
        notifications_html = f'''
            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <h3 style="color: white; margin: 0 0 15px 0;">üì± Recent Notifications</h3>
                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                    <p style="color: rgba(255,255,255,0.8); text-align: center; font-style: italic; margin: 0;">No notifications sent yet</p>
                </div>
            </div>
        '''

    html_content = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>‚ö° Rizz Meter - Omi + Hume</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            body {{
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                max-width: 900px;
                margin: 0 auto;
                padding: 20px;
                background: #f5f5f5;
            }}
            .container {{
                background: white;
                border-radius: 10px;
                padding: 30px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }}
            h1 {{
                color: #333;
                margin-top: 0;
            }}
            .status {{
                display: inline-block;
                padding: 5px 12px;
                border-radius: 5px;
                font-weight: 600;
                margin-left: 10px;
            }}
            .status.online {{
                background: #d4edda;
                color: #155724;
            }}
            .status.offline {{
                background: #f8d7da;
                color: #721c24;
            }}
            .config-section {{
                background: #f8f9fa;
                border-left: 4px solid #007bff;
                padding: 15px;
                margin: 20px 0;
            }}
            .stats {{
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin: 20px 0;
            }}
            .stat-card {{
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid #28a745;
            }}
            .stat-value {{
                font-size: 28px;
                font-weight: bold;
                color: #333;
            }}
            .stat-label {{
                color: #666;
                font-size: 14px;
                margin-top: 5px;
            }}
            .endpoint {{
                background: #e9ecef;
                padding: 10px;
                border-radius: 5px;
                font-family: monospace;
                margin: 10px 0;
            }}
            .emotions {{
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin: 15px 0;
            }}
            .emotion-tag {{
                background: #007bff;
                color: white;
                padding: 5px 12px;
                border-radius: 20px;
                font-size: 12px;
            }}
            .emotion-stats {{
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
                margin: 15px 0;
            }}
            .emotion-stat-item {{
                background: #f8f9fa;
                padding: 10px;
                border-radius: 5px;
                border-left: 3px solid #007bff;
            }}
            .emotion-stat-name {{
                font-weight: bold;
                color: #333;
                font-size: 14px;
            }}
            .emotion-stat-count {{
                color: #666;
                font-size: 12px;
                margin-top: 5px;
            }}
            .emotion-stat-bar {{
                background: #e9ecef;
                height: 8px;
                border-radius: 4px;
                margin-top: 8px;
                overflow: hidden;
            }}
            .emotion-stat-fill {{
                background: linear-gradient(90deg, #007bff, #0056b3);
                height: 100%;
                transition: width 0.3s ease;
            }}
            .refresh-btn {{
                background: #007bff;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                margin-top: 20px;
            }}
            .refresh-btn:hover {{
                background: #0056b3;
            }}
            .check {{
                color: #28a745;
                font-weight: bold;
            }}
            .cross {{
                color: #dc3545;
                font-weight: bold;
            }}
        </style>
        <script>
            function refreshPage() {{
                location.reload();
            }}

            async function resetStats() {{
                if (confirm('Are you sure you want to reset all statistics? This cannot be undone.')) {{
                    try {{
                        const response = await fetch('/reset-stats', {{
                            method: 'POST'
                        }});
                        const data = await response.json();
                        alert('Statistics reset successfully!');
                        location.reload();
                    }} catch (error) {{
                        alert('Error resetting statistics: ' + error.message);
                    }}
                }}
            }}

            // Load current config and pre-check boxes
            async function loadCurrentConfig() {{
                try {{
                    const response = await fetch('/emotion-config');
                    const data = await response.json();
                    const thresholds = data.current_config.emotion_thresholds;

                    document.querySelectorAll('.emotion-checkbox').forEach(checkbox => {{
                        checkbox.checked = checkbox.value in thresholds;
                    }});
                }} catch (error) {{
                    console.error('Error loading config:', error);
                }}
            }}

            // Select all emotions
            function selectAllEmotions() {{
                document.querySelectorAll('.emotion-checkbox').forEach(cb => cb.checked = true);
            }}

            // Clear all emotions
            function clearAllEmotions() {{
                document.querySelectorAll('.emotion-checkbox').forEach(cb => cb.checked = false);
            }}

            // Save emotion configuration
            async function saveEmotionConfig() {{
                const checkboxes = document.querySelectorAll('.emotion-checkbox:checked');
                const thresholds = {{}};

                checkboxes.forEach(cb => {{
                    thresholds[cb.value] = 0;
                }});

                const config = {{
                    notification_enabled: true,
                    emotion_thresholds: thresholds
                }};

                const statusEl = document.getElementById('saveStatus');
                statusEl.textContent = 'Saving...';
                statusEl.style.color = '#666';

                try {{
                    const response = await fetch('/emotion-config', {{
                        method: 'POST',
                        headers: {{'Content-Type': 'application/json'}},
                        body: JSON.stringify(config)
                    }});

                    if (response.ok) {{
                        statusEl.textContent = '‚úÖ Configuration saved successfully!';
                        statusEl.style.color = '#28a745';
                        setTimeout(() => {{ statusEl.textContent = ''; }}, 3000);
                    }} else {{
                        throw new Error('Save failed');
                    }}
                }} catch (error) {{
                    statusEl.textContent = '‚ùå Error saving configuration';
                    statusEl.style.color = '#dc3545';
                }}
            }}

            // Save emotion memory to Omi
            async function saveEmotionMemory() {{
                const statusEl = document.getElementById('memoryStatus');
                statusEl.textContent = 'üíæ Saving emotion summary to memories...';
                statusEl.style.color = '#666';

                try {{
                    const response = await fetch('/save-emotion-memory', {{
                        method: 'POST'
                    }});

                    const data = await response.json();

                    if (response.ok) {{
                        statusEl.textContent = '‚úÖ Emotion summary saved to memories!';
                        statusEl.style.color = '#28a745';
                        setTimeout(() => {{ statusEl.textContent = ''; }}, 3000);
                    }} else {{
                        statusEl.textContent = `‚ùå Error: ${{data.error || 'Failed to save'}}`;
                        statusEl.style.color = '#dc3545';
                    }}
                }} catch (error) {{
                    statusEl.textContent = '‚ùå Error saving to memories';
                    statusEl.style.color = '#dc3545';
                }}
            }}

            // Load config on page load
            window.addEventListener('DOMContentLoaded', loadCurrentConfig);

            // Auto-refresh every 10 seconds
            setTimeout(refreshPage, 10000);
        </script>
    </head>
    <body>
        <div class="container">
            <h1>‚ö° Rizz Meter <span style="font-size: 0.5em; color: #666;">Omi + Hume</span> <span class="status online">ONLINE</span></h1>
            <p style="text-align: center; color: #666; font-size: 16px; margin: -10px 0 5px 0; font-style: italic;">
                Emotion detection based on your tone and speech prosody
            </p>
            <p style="text-align: center; color: #999; font-size: 13px; margin: 0 0 30px 0;">
                Developer: Livia Ellen
            </p>

            <div class="config-section">
                <h3>‚öôÔ∏è Configuration Status</h3>
                <p><span class="{'check' if hume_configured else 'cross'}">{'‚úì' if hume_configured else '‚úó'}</span> Hume AI API Key: {'Configured' if hume_configured else 'Not configured'}</p>
                <p><span class="{'check' if omi_configured else 'cross'}">{'‚úì' if omi_configured else '‚úó'}</span> Omi Integration: {'Configured' if omi_configured else 'Not configured'}</p>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value">{audio_stats['total_requests']}</div>
                    <div class="stat-label">Total Requests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{audio_stats['successful_analyses']}</div>
                    <div class="stat-label">Successful Analyses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">{audio_stats['failed_analyses']}</div>
                    <div class="stat-label">Failed Analyses</div>
                </div>
            </div>

            {f'''
            <div style="margin: 20px 0;">
                <h3>üìä Last Activity</h3>
                <p><strong>Time:</strong> {audio_stats['last_request_time']}</p>
                <p><strong>User ID:</strong> {audio_stats['last_uid'][:4] + '****' if audio_stats['last_uid'] and len(audio_stats['last_uid']) > 4 else audio_stats['last_uid']}</p>
                {f'<div class="emotions">' + ''.join([f'<span class="emotion-tag">{e}</span>' for e in audio_stats['recent_emotions'][:5]]) + '</div>' if audio_stats['recent_emotions'] else ''}
            </div>
            ''' if audio_stats['last_request_time'] else '<p style="color: #666; margin: 20px 0;">No audio received yet. Waiting for Omi device to send data...</p>'}

            <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
                <h3 style="color: white; margin: 0 0 15px 0;">‚ö° Rizz Meter</h3>
                <div style="background: rgba(255,255,255,0.2); border-radius: 20px; height: 40px; position: relative; overflow: hidden;">
                    {f'''<div style="position: absolute; left: 0; width: {audio_stats.get('rizz_score', 75)}%; height: 100%; background: {'linear-gradient(90deg, #4ade80, #22c55e)' if audio_stats.get('rizz_score', 75) >= 80 else 'linear-gradient(90deg, #60a5fa, #3b82f6)' if audio_stats.get('rizz_score', 75) >= 40 else 'linear-gradient(90deg, #f87171, #ef4444)'}; transition: all 0.5s ease;"></div>''' if audio_stats.get('rizz_score') is not None else ''}
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; color: white; font-size: 12px;">
                    <span>0%</span>
                    <span style="font-size: 24px; font-weight: bold;">{audio_stats.get('rizz_score', 75):.1f}%</span>
                    <span>100%</span>
                </div>
                <p style="color: rgba(255,255,255,0.9); font-size: 12px; text-align: center; margin: 10px 0 0 0;">
                    {'üòé Positive Vibes!' if audio_stats.get('rizz_score', 75) > 80 else 'üòê Neutral Energy' if audio_stats.get('rizz_score', 75) >= 40 else 'üòî Negative Energy'}
                </p>
                {f'''
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                    <p style="color: rgba(255,255,255,0.8); font-size: 11px; margin: 5px 0;">
                        <strong>Last Updated:</strong> {audio_stats['last_request_time']}
                    </p>
                    <p style="color: rgba(255,255,255,0.8); font-size: 11px; margin: 5px 0;">
                        <strong>User:</strong> {audio_stats['last_uid'][:4] + '****' if audio_stats['last_uid'] and len(audio_stats['last_uid']) > 4 else audio_stats['last_uid']}
                    </p>
                    {f'<p style="color: rgba(255,255,255,0.8); font-size: 11px; margin: 5px 0;"><strong>Detected:</strong> {", ".join([e.split(" (")[0] for e in audio_stats["recent_emotions"][:3]])}</p>' if audio_stats['recent_emotions'] else ''}
                </div>
                ''' if audio_stats['last_request_time'] else ''}
            </div>

            {notifications_html}

            {emotion_stats_html}

            <div class="config-section">
                <h3>‚öôÔ∏è Emotion Tracking Configuration</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Select which emotions trigger notifications. Leave all unchecked for ALL emotions.
                </p>

                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button onclick="selectAllEmotions()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ‚úì Select All
                    </button>
                    <button onclick="clearAllEmotions()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ‚úó Clear All
                    </button>
                </div>

                <div id="emotionSelector" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    <!-- Positive Emotions -->
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Joy" class="emotion-checkbox">
                        <span>üòä Joy</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Amusement" class="emotion-checkbox">
                        <span>üòÑ Amusement</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Satisfaction" class="emotion-checkbox">
                        <span>üòå Satisfaction</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Excitement" class="emotion-checkbox">
                        <span>ü§© Excitement</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Desire" class="emotion-checkbox">
                        <span>üòç Desire</span>
                    </label>

                    <!-- Negative Emotions -->
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Anger" class="emotion-checkbox">
                        <span>üò† Anger</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Sadness" class="emotion-checkbox">
                        <span>üò¢ Sadness</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Anxiety" class="emotion-checkbox">
                        <span>üò∞ Anxiety</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Fear" class="emotion-checkbox">
                        <span>üò® Fear</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Distress" class="emotion-checkbox">
                        <span>üòñ Distress</span>
                    </label>

                    <!-- Neutral Emotions -->
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Calmness" class="emotion-checkbox">
                        <span>üòå Calmness</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Interest" class="emotion-checkbox">
                        <span>ü§î Interest</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Surprise" class="emotion-checkbox">
                        <span>üò≤ Surprise</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Contemplation" class="emotion-checkbox">
                        <span>ü§® Contemplation</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border-radius: 5px; cursor: pointer;">
                        <input type="checkbox" name="emotion" value="Determination" class="emotion-checkbox">
                        <span>üò§ Determination</span>
                    </label>
                </div>

                <button onclick="saveEmotionConfig()" class="refresh-btn" style="background: #007bff;">
                    üíæ Save Emotion Configuration
                </button>
                <p id="saveStatus" style="color: #666; font-size: 14px; margin-top: 10px;"></p>
            </div>

            <div class="config-section">
                <h3>üîå API Endpoints</h3>
                <p><strong>Audio Upload (Prosody):</strong></p>
                <div class="endpoint">POST /audio?sample_rate=16000&uid=your_user_id</div>
                <p style="font-size: 12px; color: #666; margin: 5px 0;">Analyzes speech emotion from audio tone/pitch (‚â§5 seconds)</p>

                <p><strong>Text Emotion Analysis:</strong></p>
                <div class="endpoint">POST /analyze-text?uid=your_user_id</div>
                <p style="font-size: 12px; color: #666; margin: 5px 0;">Analyzes emotion from text content (‚â§10,000 chars)</p>

                <p><strong>Health Check:</strong></p>
                <div class="endpoint">GET /health</div>

                <p><strong>Status Dashboard:</strong></p>
                <div class="endpoint">GET /status</div>
            </div>

            <div class="config-section">
                <h3>üì± Configure Your Omi Device</h3>
                <ol>
                    <li>Open the <strong>Omi App</strong></li>
                    <li>Go to <strong>Settings ‚Üí Developer Mode</strong></li>
                    <li>Set <strong>"Realtime audio bytes"</strong> to:</li>
                    <div class="endpoint" id="audioUrl">{os.getenv('NGROK_URL', 'https://your-ngrok-url.ngrok-free.app')}/audio</div>
                    <li>Set <strong>"Every x seconds"</strong> to <code>10</code></li>
                </ol>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="refresh-btn" onclick="refreshPage()">üîÑ Refresh Status</button>
                <button class="refresh-btn" onclick="saveEmotionMemory()" style="background: #28a745;">üíæ Save to Memories</button>
                <button class="refresh-btn" onclick="resetStats()" style="background: #dc3545;">üóëÔ∏è Reset Statistics</button>
            </div>
            <p id="memoryStatus" style="color: #666; font-size: 14px; margin-top: 10px;"></p>
            {'<p style="color: #28a745; font-size: 13px; margin-top: 10px;">‚úì User ID: ' + audio_stats.get("last_uid", "Not available") + '</p>' if audio_stats.get("last_uid") else '<p style="color: #ff9800; font-size: 13px; margin-top: 10px;">‚ö†Ô∏è No audio received yet. Speak into your Omi device first.</p>'}
            <p style="color: #666; font-size: 12px; margin-top: 10px;">Page auto-refreshes every 10 seconds</p>
        </div>
    </body>
    </html>
    """
    return HTMLResponse(content=html_content)


@app.get("/status")
async def get_status():
    """Get current server status and stats"""
    hume_configured = bool(os.getenv('HUME_API_KEY'))
    omi_configured = bool(os.getenv('OMI_APP_ID') and os.getenv('OMI_API_KEY'))

    return JSONResponse({
        "status": "online",
        "service": "omi-audio-streaming",
        "configuration": {
            "hume_ai": hume_configured,
            "omi_integration": omi_configured
        },
        "stats": audio_stats
    })


@app.post("/analyze-text")
async def analyze_text_emotion(
    request: Request,
    uid: Optional[str] = Query(None, description="User ID (optional)")
):
    """
    Endpoint to analyze emotion from text using Hume AI Language model.

    This analyzes emotional content based on word choice, phrasing, and linguistic patterns.
    Use this endpoint with transcribed text from speech-to-text services.

    Query Parameters:
        - uid: User unique ID (optional)

    Body (JSON):
        {
            "text": "Your text to analyze here",
            "metadata": {...}  // optional metadata
        }

    Example curl:
        curl -X POST "https://your-url/analyze-text?uid=user123" \
             -H "Content-Type: application/json" \
             -d '{"text": "I am feeling really happy and excited today!"}'
    """
    try:
        # Parse JSON body
        body = await request.json()
        text = body.get('text')
        metadata = body.get('metadata', {})

        if not text:
            raise HTTPException(status_code=400, detail="Missing 'text' field in request body")

        # Check text length (API limit is 10,000 characters)
        if len(text) > 10000:
            raise HTTPException(
                status_code=400,
                detail=f"Text too long ({len(text)} characters). Maximum is 10,000 characters."
            )

        print(f"Analyzing text emotion for user: {uid or 'anonymous'}")
        print(f"Text length: {len(text)} characters")
        print(f"Text preview: {text[:100]}...")

        # Analyze text with Hume AI
        hume_results = await analyze_text_with_hume(text)

        response_data = {
            "message": "Text emotion analysis complete",
            "text_length": len(text),
            "uid": uid,
            "hume_analysis": hume_results,
            "metadata": metadata
        }

        return JSONResponse(
            status_code=200,
            content=response_data
        )

    except HTTPException:
        raise
    except json.JSONDecodeError:
        raise HTTPException(status_code=400, detail="Invalid JSON in request body")
    except Exception as e:
        print(f"Error analyzing text: {e}")
        raise HTTPException(status_code=500, detail=f"Internal server error: {str(e)}")


@app.get("/emotion-config")
async def get_emotion_config():
    """Get current emotion notification configuration"""
    return {
        "current_config": EMOTION_CONFIG,
        "description": "Automatic notification settings for detected emotions"
    }


@app.post("/emotion-config")
async def update_emotion_config(request: Request):
    """
    Update emotion notification configuration

    Body (JSON):
    {
        "notification_enabled": true,
        "emotion_thresholds": {
            "Anger": 0.7,
            "Sadness": 0.6
        }
    }
    """
    global EMOTION_CONFIG

    try:
        new_config = await request.json()

        # Validate config
        if "notification_enabled" in new_config:
            if not isinstance(new_config["notification_enabled"], bool):
                raise HTTPException(status_code=400, detail="notification_enabled must be boolean")

        if "emotion_thresholds" in new_config:
            if not isinstance(new_config["emotion_thresholds"], dict):
                raise HTTPException(status_code=400, detail="emotion_thresholds must be a dict")

            # Validate thresholds are numbers between 0 and 1
            for emotion, threshold in new_config["emotion_thresholds"].items():
                if not isinstance(threshold, (int, float)) or threshold < 0 or threshold > 1:
                    raise HTTPException(
                        status_code=400,
                        detail=f"Threshold for {emotion} must be between 0 and 1"
                    )

        # Update configuration
        EMOTION_CONFIG.update(new_config)

        # Save to file
        config_file = Path("emotion_config.json")
        with open(config_file, 'w') as f:
            json.dump(EMOTION_CONFIG, f, indent=2)

        print(f"‚úì Updated emotion config: {EMOTION_CONFIG}")

        return {
            "message": "Configuration updated successfully",
            "new_config": EMOTION_CONFIG
        }

    except json.JSONDecodeError:
        raise HTTPException(status_code=400, detail="Invalid JSON in request body")
    except Exception as e:
        print(f"Error updating config: {e}")
        raise HTTPException(status_code=500, detail=f"Internal server error: {str(e)}")


@app.post("/reset-stats")
async def reset_stats():
    """Reset all statistics"""
    global audio_stats
    audio_stats = {
        "total_requests": 0,
        "successful_analyses": 0,
        "failed_analyses": 0,
        "last_request_time": None,
        "last_uid": None,
        "recent_emotions": [],
        "emotion_counts": {},
        "rizz_score": 75,
        "recent_notifications": []
    }
    return {"message": "Statistics reset successfully", "stats": audio_stats}


@app.post("/save-emotion-memory")
async def manual_save_emotion_memory(uid: Optional[str] = Query(None, description="User ID (optional)")):
    """
    Manually save current emotion statistics to Omi memories.

    Query Parameters:
        - uid: User ID (optional, uses last active user if not provided)
    """
    result = await save_emotion_memory(uid)

    if result.get("success"):
        return JSONResponse(
            status_code=200,
            content={
                "message": "Emotion memory saved successfully",
                "result": result
            }
        )
    else:
        return JSONResponse(
            status_code=400,
            content={
                "message": "Failed to save emotion memory",
                "error": result.get("error")
            }
        )


@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {"status": "healthy", "service": "omi-audio-streaming"}


if __name__ == "__main__":
    # Run the server
    uvicorn.run(app, host="0.0.0.0", port=8080)
